(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{439:function(e,t,a){"use strict";a.r(t);var s=a(46),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("ul",[a("li",[e._v("Runs on "),a("a",{attrs:{href:"piper",title:"wikilink"}},[e._v("piper")]),e._v(" - "),a("code",[e._v("piper.tardis.ed.ac.uk")])]),e._v(" "),a("li",[e._v("There is also an alias, "),a("code",[e._v("ldap.tardis.ed.ac.uk")]),e._v(".")])]),e._v(" "),a("h2",{attrs:{id:"installation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#installation"}},[e._v("#")]),e._v(" Installation")]),e._v(" "),a("p",[e._v("(Usual caveats; stuff might have changed, pay attention, etc)")]),e._v(" "),a("p",[e._v('Install slapd, and optionally ldap-utils and ldapvi (should you want to\nbe able to try it out from the server). The slapd package attempts to be\nhelpful, asking a bunch of configuration questions and starting the\nservice. Curiously, I didn\'t see the "don\'t configure slapd for me" as\none of the options first time around and needed to reconfigure the\npackage. Say "yes" to "Omit OpenLDAP server configuration?".')]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("piper:~# /etc/init.d/slapd stop\npiper:~# dpkg-reconfigure slapd\n")])])]),a("p",[e._v("Keep a copy of the default configuaration in case someone wants to see\nhow Debian configures stuff, and copy across the main configuration\nfile, the SSL files and the schema files that don't ship with OpenLDAP.\n(You might want to check this stuff, as some of it can probably be\nchucked. Actually, I just turfed krb5-kdc.schema because we don't use it\nand it suffered parsing errors. An old piece of syntax in the\nconfiguration file needed fixed too.)")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("piper:~# cd /etc/ldap\npiper:/etc/ldap# cp slapd.conf slapd.conf.dpkg\npiper:/etc/ldap# mkdir -p /etc/ssl/certs\n\nroot@baker:~# cd /etc/ldap\nroot@baker:/etc/ldap# scp slapd.conf root@piper:/etc/ldap\nroot@baker:/etc/ldap# scp /etc/ssl/certs/ldapcert.pem /etc/ssl/certs/ldapkey.pem  root@piper:/etc/ssl/certs\nroot@baker:/etc/ldap# scp /etc/ssl/cacert.pem  root@piper:/etc/ssl/\nroot@baker:/etc/ldap/schema# scp amd.schema courier.schema krb5-kdc.schema tardis.schema root@piper:/etc/ldap/schema\n")])])]),a("p",[e._v("Also, edit /etc/default/slapd to enable all the methods of connecting by\nputting in the line")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v('SLAPD_SERVICES="ldap:/// ldaps:/// ldapi:///"\n')])])]),a("p",[e._v("At this point it should start and stop without moaning about syntax\nerrors. If not, see if you can fix them.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("piper:/etc/ldap# /etc/init.d/slapd start\nStarting OpenLDAP: running BDB recovery, slapd.\npiper:/etc/ldap# /etc/init.d/slapd stop\nStopping OpenLDAP: slapd.\n")])])]),a("p",[e._v('Now grab a recent backup, comment out the "search" and "result" lines at\nthe end (because the backups are generated by ldapsearch, but we\'re\ngoing to import them with slapadd), clear out the old database and\nimport the backup:')]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("piper:/etc/ldap# cp <whereever>/backup-20060225.ldif /tmp/backup-20060225.ldif\npiper:/etc/ldap# vi /tmp/backup-20060225.ldif\n\n<comment out search and result lines near end>\n\npiper:/etc/ldap# cd /var/lib/ldap\npiper:/var/lib/ldap# mkdir old\npiper:/var/lib/ldap# mv * old\nmv: cannot move `old' to a subdirectory of itself, `old/old'\npiper:/var/lib/ldap# slapadd -l /tmp/backup-20060225.ldif\npiper:/var/lib/ldap# /etc/init.d/slapd start\n")])])]),a("p",[e._v("Now you can test it.")]),e._v(" "),a("h2",{attrs:{id:"the-backup-script"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-backup-script"}},[e._v("#")]),e._v(" The backup script")]),e._v(" "),a("p",[e._v("The backup script had to be moved to the new server:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("piper:~# mkdir -p ldap/backups\npiper:~# chmod og-rwx ldap\n\nbaker:~# scp bin/backupldap bin/ldappasswd root@piper:/root/ldap\nPassword:\nbackupldap                                    100%  254     0.3KB/s   00:00\nldappasswd                                    100%    7     0.0KB/s   00:00\n")])])]),a("p",[e._v("A cron job needs to be added for it, and the old cron job on the old\nserver needs to be removed because it stores the backups in the same\nplace!")]),e._v(" "),a("h2",{attrs:{id:"synchronising"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#synchronising"}},[e._v("#")]),e._v(" Synchronising")]),e._v(" "),a("p",[e._v("For the baker to piper move, I used the replog option on the old server\nto watch for changes and grabbed a fresh backup copy and imported it as\nabove. There were no changes on the old server (changes to our LDAP\ndatabase are infrequent), so I no further synchronisation was required.")]),e._v(" "),a("p",[e._v("For future synchronisation, the built in LDAP Sync support in the\ncurrent versions of OpenLDAP will probably be easier.")]),e._v(" "),a("h2",{attrs:{id:"useful-stuff"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#useful-stuff"}},[e._v("#")]),e._v(" Useful stuff")]),e._v(" "),a("p",[e._v("To watch for attempts to use the old server you can use the debugging\nsupport in OpenLDAP. Sticking "),a("code",[e._v("-d 260")]),e._v(" on to the normal slapd command\nline worked well for me.")]),e._v(" "),a("p",[e._v("Files that may need updated to point to a new server:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("/etc/ldap/ldap.conf\n/etc/pam_ldap.conf\n/etc/libnss-ldap.conf\n/root/scripts/generatemaps\n/etc/tardis/ldap.conf\n/etc/apache/vhosts/www.tardis.ed.ac.uk\n/etc/postfix/main.cf\n")])])]),a("p",[a("a",{attrs:{href:"category:services",title:"wikilink"}},[e._v("category:services")]),e._v(" "),a("a",{attrs:{href:"category:infrastructure",title:"wikilink"}},[e._v("category:infrastructure")])]),e._v(" "),a("p",[a("a",{attrs:{href:"Category:OutOfDate",title:"wikilink"}},[e._v("Category:OutOfDate")])])])}),[],!1,null,null,null);t.default=n.exports}}]);